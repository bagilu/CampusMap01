<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Supabase TblSpace æ¸¬è©¦é é¢</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      margin: 20px;
      padding: 0;
      background-color: #f7f7f7;
    }
    h1 {
      font-size: 1.5rem;
      margin-bottom: 10px;
    }
    #status {
      margin: 10px 0;
      color: #555;
    }
    #error {
      color: #b00020;
      margin: 10px 0;
      white-space: pre-wrap;
    }
    .search-bar {
      margin: 10px 0 20px 0;
    }
    .search-bar label {
      margin-right: 8px;
      font-weight: 600;
    }
    .search-bar input {
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      min-width: 200px;
    }
    .search-bar button {
      padding: 6px 12px;
      margin-left: 6px;
      border-radius: 4px;
      border: 1px solid #007bff;
      background-color: #007bff;
      color: #fff;
      cursor: pointer;
    }
    .search-bar button:hover {
      opacity: 0.9;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }
    thead {
      background: #f0f0f0;
    }
    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid #eee;
      font-size: 0.9rem;
      text-align: left;
    }
    tr:last-child td {
      border-bottom: none;
    }
    .no-data {
      padding: 10px;
    }
  </style>
</head>
<body>
  <h1>Supabase æ¸¬è©¦ï¼šTblSpace æŸ¥è©¢</h1>

  <div id="status">ç‹€æ…‹ï¼šæº–å‚™é€£ç·šè‡³ Supabaseâ€¦</div>
  <div id="error"></div>

  <!-- ğŸ” æœå°‹å€ï¼šè¼¸å…¥ç©ºé–“åç¨± -->
  <div class="search-bar">
    <label for="search-input">è«‹è¼¸å…¥ç©ºé–“åç¨±ï¼š</label>
    <input type="text" id="search-input" placeholder="ä¾‹å¦‚ï¼šæœƒè­°å®¤" />
    <button id="search-btn">æœå°‹</button>
    <button id="reset-btn">é¡¯ç¤ºå‰ 10 ç­†</button>
  </div>

  <!-- è³‡æ–™è¡¨æ ¼ -->
  <table id="space-table" style="display:none;">
    <thead>
      <tr id="table-head-row"></tr>
    </thead>
    <tbody id="space-tbody"></tbody>
  </table>

  <!-- 1. å…ˆè¼‰å…¥å­˜æ”¾ URL èˆ‡ Key çš„ config.jsï¼ˆè·¯å¾‘èˆ‡æª”åè«‹ç¢ºèªï¼‰ -->
  <script src="./config.js"></script>

  <!-- 2. è¼‰å…¥ Supabase JS SDK (v2, CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

  <!-- 3. ä¸»ç¨‹å¼ï¼šå»ºç«‹é€£ç·šã€æŸ¥è©¢ TblSpaceã€é¡¯ç¤ºçµæœ -->
  <script>
    // æª¢æŸ¥ config.js æ˜¯å¦æ­£ç¢ºè¼‰å…¥
    if (typeof SUPABASE_URL === "undefined" || typeof SUPABASE_ANON_KEY === "undefined") {
      document.getElementById("status").textContent = "ç‹€æ…‹ï¼šç„¡æ³•æ‰¾åˆ° SUPABASE_URL æˆ– SUPABASE_ANON_KEY";
      document.getElementById("error").textContent =
        "è«‹ç¢ºèª config.js æ˜¯å¦åœ¨åŒä¸€å€‹è³‡æ–™å¤¾ï¼Œä¸”è®Šæ•¸åç¨±æ­£ç¢ºã€‚";
    } else {
      document.getElementById("status").textContent = "ç‹€æ…‹ï¼šæ­£åœ¨é€£ç·šè‡³ Supabaseâ€¦";

      // å»ºç«‹ supabase clientï¼ˆv2 å¯«æ³•ï¼‰
      const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // å…±ç”¨å‡½å¼ï¼šæŠŠè³‡æ–™é¡¯ç¤ºæˆè¡¨æ ¼ï¼ˆå‹•æ…‹ä¾æ¬„ä½è‡ªå‹•ç”¢ç”Ÿ 7 æ¬„ï¼‰
      function renderTable(data) {
        const table = document.getElementById("space-table");
        const theadRow = document.getElementById("table-head-row");
        const tbody = document.getElementById("space-tbody");

        // å…ˆæ¸…ç©º
        theadRow.innerHTML = "";
        tbody.innerHTML = "";

        if (!data || data.length === 0) {
          table.style.display = "none";
          return;
        }

        // ç”±ç¬¬ä¸€ç­†è³‡æ–™è‡ªå‹•å–å¾—æ‰€æœ‰æ¬„ä½åç¨±
        const columns = Object.keys(data[0]);

        // ç”¢ç”Ÿè¡¨é ­
        columns.forEach(col => {
          const th = document.createElement("th");
          th.textContent = col;
          theadRow.appendChild(th);
        });

        // ç”¢ç”Ÿæ¯ä¸€åˆ—è³‡æ–™
        data.forEach(row => {
          const tr = document.createElement("tr");
          columns.forEach(col => {
            const td = document.createElement("td");
            td.textContent = row[col] ?? "";
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });

        table.style.display = "table";
      }

      // è¼‰å…¥è³‡æ–™ï¼šå¦‚æœæœ‰ keywordï¼Œåšæ¨¡ç³Šæœå°‹ï¼›å¦å‰‡é¡¯ç¤ºå‰ 10 ç­†
      async function loadSpaces(keyword = "") {
        const statusEl = document.getElementById("status");
        const errorEl = document.getElementById("error");

        statusEl.textContent = "ç‹€æ…‹ï¼šè³‡æ–™è®€å–ä¸­â€¦";
        errorEl.textContent = "";

        let query = supabaseClient
          .from("TblSpace")
          .select("*");   // å–å‡ºæ‰€æœ‰æ¬„ä½ï¼ˆ7 å€‹æ¬„ä½ï¼‰

        if (keyword && keyword.trim() !== "") {
          // æ¨¡ç³Šæœå°‹ï¼šSpaceName æ¬„ä½åŒ…å«é—œéµå­—ï¼ˆä¸åˆ†å¤§å°å¯«ï¼‰
          query = query.ilike("SpaceName", `%${keyword.trim()}%`);
        } else {
          // æ²’æœ‰é—œéµå­—æ™‚ï¼Œåªé¡¯ç¤ºå‰ 10 ç­†
          query = query.limit(10);
        }

        const { data, error } = await query;

        if (error) {
          statusEl.textContent = "ç‹€æ…‹ï¼šè®€å–å¤±æ•—";
          errorEl.textContent = "éŒ¯èª¤è¨Šæ¯ï¼š\n" + error.message;
          console.error("Supabase error:", error);
          renderTable([]); // æ¸…ç©ºè¡¨æ ¼
          return;
        }

        statusEl.textContent =
          "ç‹€æ…‹ï¼šè®€å–æˆåŠŸï¼Œå…±å–å¾— " + (data ? data.length : 0) + " ç­†è³‡æ–™";

        if (!data || data.length === 0) {
          renderTable([]);
          const tbody = document.getElementById("space-tbody");
          const theadRow = document.getElementById("table-head-row");
          theadRow.innerHTML = "";
          tbody.innerHTML = "";
          const table = document.getElementById("space-table");
          table.style.display = "none";
          return;
        }

        renderTable(data);
      }

      // ä¸€è¼‰å…¥é é¢å°±å…ˆé¡¯ç¤ºå‰ 10 ç­†
      loadSpaces();

      // ç¶å®šæœå°‹æŒ‰éˆ•
      document.getElementById("search-btn").addEventListener("click", () => {
        const keyword = document.getElementById("search-input").value;
        loadSpaces(keyword);
      });

      // ç¶å®šã€Œé¡¯ç¤ºå‰ 10 ç­†ã€æŒ‰éˆ•
      document.getElementById("reset-btn").addEventListener("click", () => {
        document.getElementById("search-input").value = "";
        loadSpaces("");
      });

      // è®“ä½¿ç”¨è€…æŒ‰ Enter ä¹Ÿèƒ½æœå°‹
      document.getElementById("search-input").addEventListener("keyup", (e) => {
        if (e.key === "Enter") {
          const keyword = e.target.value;
          loadSpaces(keyword);
        }
      });
    }
  </script>
</body>
</html>
